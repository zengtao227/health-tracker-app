# Health Tracker App 需求规格说明书 (PRD)

**版本**: 1.0  
**日期**: 2026-01-30  
**状态**: 草稿 (Draft)

---

## 1. 项目背景与范围 (Background & Scope)

### 1.1 项目背景
用户需要在 Android 手机上统一记录和管理个人的健康数据（主要是血压、心率、体重），并能够方便地查看历史趋势，辅助健康管理。现有的记录方式可能分散或不支持特定的医学计算逻辑（如“去首求平均”）。

### 1.2 业务目标
- **核心价值**: 提供一个符合医学测量规范（如多次测量取平均）的健康数据记录工具。
- **用户体验**: 极简操作，单屏无滚动主界面，快速录入，直观的趋势图表。
- **数据自主**: 数据本地存储，支持标准的 CSV/Excel 导入导出，确保用户拥有数据主权。

### 1.3 项目范围
- **包含**: 
    - Android 原生应用 (Kotlin + Jetpack Compose)。
    - 本地数据库 (Room/SQLite)。
    - 血压、心率、体重的录入、计算、存储、展示、导出。
    - 历史数据导入 (CSV)。
- **不包含**:
    - 云端同步 (目前仅本地，未来可扩展 Google Drive)。
    - 社交分享功能 (仅文件分享)。
    - 多用户管理 (仅单用户)。

---

## 2. 详细功能清单 (Functional Requirements)

### 2.1 模块一：数据录入与计算 (Measurement & Calculation)
**用户故事**: 作为用户，我希望在测量血压时，能够连续测几次，系统自动帮我按规则计算最终结果，而不是让我自己算。

*   **交互流程**:
    1.  点击“开始测量” (Start Measuring)。
    2.  输入第 1 次数据 -> 界面显示“已测 1 次”。
    3.  输入第 2 次数据 -> 界面显示“已测 2 次”。
    4.  ...
    5.  点击“完成” (Finish)。
    6.  系统计算并保存，清空输入框。

*   **计算逻辑 (核心)**:
    - **1 次测量**: 直接使用该值。
    - **2 次测量**: 丢弃第 1 次，使用第 2 次的值。
    - **3 次及以上**: 丢弃第 1 次，取第 2 次和第 3 次的平均值 (简单算术平均)。
    - **适用范围**: 血压 (SBP/DBP)、心率 (HR)、体重 (Weight) 同步应用此逻辑。

### 2.2 模块二：主界面导航 (Navigation) & 页面布局
**用户故事**: 我希望 Home 页面能让我一打开就准备好开始测量，Trends 页面能让我看清不同时间段的变化。

*   **布局要求**:
    - **单屏无滚动**: 应用框架固定，内容区域内部滚动。
    - **颜色映射 (WHO Blood Pressure Standards)**:
        - 🔴 **红色 (Grade 2/3 Hypertension)**: SBP ≥ 160 或 DBP ≥ 100
        - 🟠 **橙色 (Grade 1 Hypertension)**: SBP 140-159 或 DBP 90-99
        - 🟢 **绿色 (Normal / High Normal)**: SBP 120-139 或 DBP 80-89
        - 🔵 **蓝色 (Optimal)**: SBP < 120 且 DBP < 80
    - **底部导航栏 (Bottom Navigation)**: 
        1.  **Home** (操作中心): 
            - **核心**: 巨大的“开始测量 (Take a Reading)” 动作区域。
            - 状态指示: 今日是否已测。
            - 背景卡片: 上次测量结果预览。
        2.  **Trends** (动态趋势): 
            - **时间维度**: 显式的 **7D**, **30D**, **1Y**, **MAX (From Beginning)** 切换。
            - **图表增强**: 血压(SBP/DBP Area Chart) + 体重(Dual-axis Line) + 心率。视觉对比度高，背景带细格栅。
            - 指标看板: 所选时间段内的 Avg / Max / Min 提示。
        3.  **Reports** (专业报告): 
            - **内容**: 周报/月报自动生成预览。
            - **汇总**: 包含收缩压/舒张压在所选期间的达标率分析环形图。
            - 导出入口: 直接点击导出 PDF/Excel。
        4.  **Settings** (个人与资料): 
            - Profile 管理。
            - CSV 复古数据补充入口。

### 2.3 模块三：多维趋势分析 (Multi-period Analysis)
*   **时间范围控制**:
    - **7D**: 查看短期波动。
    - **30D**: 查看月度控制水平。
    - **1Y**: 查看季节性变化。
    - **MAX**: 全生命周期数据追踪。
*   **交互细节**: 点击图表数据点应弹出详细数值 (SBP/DBP/WT)。

### 2.4 模块四：报告与数据导出 (Reports & Export)
*   **报告定义**: 报告页面不再是简单的列表，而是经过聚合的数据摘要。
    - 示例: "本月平均血压 125/82，较上月下降 2%，处于理想区间。"
*   **历史补录**: 支持用户手动输入或批量上传旧数据，并自动重绘趋势图。

---

## 3. 数据模型与接口规范 (Data Model)

### 3.1 本地数据库 (Room)
*   **表名**: `health_records`
*   **Schema**:

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | Long | Primary Key, AutoInc | 内部主键 |
| `date` | String | Unique, Not Null | 格式 "yyyy-MM-dd" |
| `sbp` | Int | Nullable | 收缩压 |
| `dbp` | Int | Nullable | 舒张压 |
| `hr` | Int | Nullable | 心率 |
| `weight` | Float | Nullable | 体重 |
| `createdAt`| Long | Not Null | 创建时间戳 |

### 3.2 接口/逻辑规范
*   **CSV 解析**: 必须校验日期格式，忽略空行和非法格式行。
*   **事务处理**: 批量导入 (Bulk Import) 必须在事务 (`@Transaction`) 中执行，确保原子性。

---

## 4. 非功能性需求 (Non-functional Requirements)

### 4.1 性能 (Performance)
*   **图表渲染**: 2000 个数据点以内，滑动流畅度保持 60fps。
*   **数据导入**: 5000 条 CSV 数据导入耗时 ≤ 3秒。

### 4.2 兼容性 (Compatibility)
*   **系统版本**: Android 8.0 (API 26) 及以上。
*   **深色模式**: 支持跟随系统自动切换 Dark/Light 模式。

### 4.3 可维护性 (Maintainability)
*   **架构**: MVVM (Model-View-ViewModel)。
*   **代码规范**: Kotlin 风格指南，清晰的命名。

---

## 5. 测试场景与验收标准 (Test & Acceptance)

### 5.1 单元测试 (Unit Tests)
*   [ ] **计算逻辑**: 覆盖 1次、2次、3次、4次输入，断言结果符合“去首求平均”规则。
*   [ ] **CSV 解析**: 测试缺失列、错误日期格式、非数字字符的异常处理。
*   [ ] **颜色映射**: 测试边界值 (159 vs 160, 99 vs 100)。

### 5.2 UI/集成验收 (Checklist)
*   [ ] **导航**: 底部 4 个 Tab 切换正常，且主界面无额外滚动条。
*   [ ] **Stats**: 
    *   能同时看到 4 条曲线（或按需隐藏）。
    *   点击 "Max" 能看到所有历史数据。
    *   图例颜色与文字描述一致。
    *   血压点的颜色根据数值正确变化。
*   [ ] **History**: 列表按日期倒序排列。
*   [ ] **Import**: 导入 5000 条数据不崩溃，且导入后数据正确覆盖旧数据。
*   [ ] **Theme**: 切换手机深色模式，App 界面自动变黑，文字清晰可见。

---

## 6. 交付物 (Deliverables)

1.  **Release APK**: 签名的安装包。
2.  **Source Code**: 完整的 Git 仓库代码。
3.  **Test Assets**: 
    *   测试账号 (如需网关)。
    *   样例 CSV 文件 (包含正常数据和边界数据)。
4.  **Report**: 单元测试通过报告 (截图或日志)。

---

## 7. 风险评估 (Risks)

*   **风险**: MPAndroidChart 在极大数据量 (例如 10年数据) 下的性能问题。
    *   *应对*: 限制默认加载的数据量，或者在 View 层做数据抽稀 (Downsampling)。
*   **风险**: CSV 文件编码问题 (如 GBK vs UTF-8)。
    *   *应对*: 默认支持 UTF-8，若出现乱码提示用户转码。

---

## 8. 后续发展计划 (Future Development Plan)

### 8.1 模块化功能扩展 (Modular Functionality)
**用户故事**: 随着健康管理需求的多样化，我希望只关注对自己重要的指标，而不是被无关的功能占据屏幕。

*   **功能逻辑**:
    - **模块库 (Module Library)**: 应用将建立一个功能池，包含：
        - **必选/默认**: 血压 (BP)、心率 (HR)、体重 (WT)。
        - **可选扩展**: 血糖 (Blood Glucose)、尿酸 (Uric Acid)、血氧 (SpO2) 等。
    - **自定义首页**: 用户可以在“模块管理”中自由勾选。首页将根据勾选结果动态渲染对应的录入卡片和简报。

### 8.2 动态布局与交互 (Dynamic Layout)
*   **滚动适配**: 
    - 考虑到模块增多后单屏可能无法完全容纳，首页列表应支持 **垂直滚动 (Vertical Scroll)**。
    - 模块较少时保持原有“简约单屏”感；模块较多时允许上下移动。
*   **排序与编辑**: 支持用户长按模块进行位置交换 (Drag & Drop)，优先展示最关心的指标。

### 8.3 数据模型平滑演进
*   **架构演进**: 为了支持快速添加新模块（如“尿酸”），系统架构应考虑：
    - **UI 组件化**: 将每种指标的录入和展示封装为独立的 Component。
    - **数据通用化**: 后台数据库能够适配不同类型的数值记录，无需每次增加模块都修改 SQL Schema。

---

## 9. 核心算法规范 (Core Calculation Standards)

为了确保跨平台应用的一致性与专业性，系统各模块必须遵循以下底层算法标准。

### 9.1 黄历（黄利）计算：双端共识权威逻辑
**原则**: 必须与 macOS/Android 版实现 1:1 同步，严禁使用独立简化的平均数算法。

*   **计算模型**:
    1.  **基准锚点**: 以 `2024-02-10 12:00:00` (甲辰日) 为日期偏移基准。
    2.  **精准月长查找法**: 必须引入 `[30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30]` 数组，通过逐月遍历累减天数来推算农历月日，严禁使用 `days/30` 的近似值。
    3.  **2026 跨年分界**: 2026年春节锁定为 `2月17日`。在此日期前，生肖与干支年必须保持为“乙巳蛇年”，即使公历已进入 2026。

### 9.2 UI 呈现：中轴对称与平衡规范
**原则**: 强调仪式感与对称美，复刻 macOS/iOS 版的高级感排版。

*   **布局逻辑**:
    1.  **中轴对齐**: 所有文字（阳历、阴历、神位、宜/忌）必须水平居中对齐 `textAlign: 'center'`。
    2.  **徽章化标签**: “宜”与“忌”标签采用胶囊形色块（绿色/红色背景，白色文字），且徽章本身必须在中轴线上。
    3.  **内容平衡拆分 (Balance Rows)**: 
        - 对“宜/忌”列表进行单词统计。
        - 若词数 ≥ 4（如“开市 交易 纳财 出行”），则在中间（或奇数位置）插入强制换行符 `\n`。
        - 确保多行显示时，上下两行的词数差距最小，形成视觉上的矩形或稳重梯形。

### 9.3 起卦算法：大衍筮法仿真 (Dayan Method)
**原则**: 废弃随机抽卦，模拟真实的“三变”掷币/分草概率。

*   **概率分布**:
    - **老阳 (9)**: 3/16 (由阳变阴)
    - **老阴 (6)**: 1/16 (由阴变阳)
    - **少阳 (7)**: 7/16 (稳定)
    - **少阴 (8)**: 5/16 (稳定)
*   **交互要求**: 增加长按仪式（如“长按3秒”），模拟冥想感生的过程。

---
